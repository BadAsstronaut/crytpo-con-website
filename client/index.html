<!DOCTYPE html>

<head>
  <meta charset="utf-8">

  <title>Test client code</title>
</head>

<body>
  <h1>Globee Interactions</h1>

  <div>
    <label for="name">
      Name:
    </label>
    <input type="text" name="name" id="globee-name-input" />
  </div>
  <div>
    <label for="email">
      Email:
    </label>
    <input type="email" name="email" id="globee-email-input" />
  </div>
  <div>
    <label for="globee-ticket-select">
      Ticket Type:
    </label>
    <select id="globee-ticket-select">
      <option value="">Select an option...</option>
      <option value="tier-one-ticket">Tier 1 Ticket</option>
      <option value="tier-two-ticket">Tier 2 Ticket</option>
    </select>
  </div>
  <input type="submit" id="globee-submit">

  <script src="index.js"></script>

  <script>
    const setUp = () => {
      const formControls = {
        purchaserName: document.getElementById('ticket-purchaser-name'),
        purchaserEmail: document.getElementById('ticket-purchaser-email'),
        tierOptions: document.querySelectorAll('input[name="ticketTier"]'),
        numTickets: document.getElementById('num-tickets'),
        paymentType: document.getElementById('payment-type'),
        submit: document.getElementbyId('submit-payment'),
      };

      formControls.numTickets.addEventListener('change', e => {
        e.preventDefault();
        const numAttendees = parseInt(e.target.value || 0, 10);
        const target = document.getElementById('attendee-data');
        const elems = [...Array(numAttendees).keys()].map((el, idx) => (`
        <div class="form-item field required">
          <label for="attendeeName-${idx + 1}">Attendee ${idx + 1} Name<span class="required">*</span></label>
          <input id="attendeeName-${idx + 1}" name="attendeeName" type="text" spellcheck="false" class="field-element" />
          <label for="attendeeInstitution-${idx + 1}">Attendee ${idx + 1} Institution</label>
          <input id="attendeeInstitution-${idx + 1}" Institution="attendeeInstitution-${idx}" type="text" spellcheck="false" class="field-element" />
        </div>
      `));
        target.innerHTML = elems.join('');
      });

      const validate = () => {
        const errs = [];

        if (!formControls.purchaserName.value) {
          errs.push('Name');
        }

        if (!formControls.purchaserEmail.value) {
          errs.push('Email');
        }

        if (![...formControls.tierOptions].filter(el => el.checked).length === 1) {
          errs.push('Ticket Tier');
        }

        const attendeeNameInputs = document.querySelectorAll('input[name="attendeeName"]');

        if ([...attendeeNameInputs].filter(el => !el.value) > 0) {
          errs.push('Attendee Name(s)');
        }

        if (formControls.paymentType.value === 'stripe') {
          errs.push('Credit Card Information');
        }

        return errs;
      };

      const submitGlobeePayment = () => {
        const attendees = [...Array(formControls.numTickets.value)].map((i, idx) => {
          return {
            name: document.getElementById(`attendeeName-${idx + 1}`).value,
            institution: document.getElementById(`attendeeInstitution-${idx + 1}`).value,
          };
        });

        const payload = {
          purchaserName: formControls.purchaserName.value,
          purchaserEmail: formControls.purchaserEmail.value,
          tier: [...formControls.tierOptions].filter(el => el.checked).value,
          attendees,
        };

        const endpoint = 'https://zeug267d9l.execute-api.us-east-2.amazonaws.com/v1/globee-payment';

        fetch(endpoint, {
          method: 'post',
          body: JSON.stringify(payload),
          headers: {
            Accept: 'application/json',
            'Content-Type': 'application/json',
          },
        })
          .then(res => res.data)
          .then(result => {
            console.log(result);
            window.location.replace(result.redirectUrl);
          })
          .catch(err => (alert("An error has occurred =(")));
      };

      const submitStripePayment = () => { };

      formControls.submit.addEventListener('click', e => {
        e.preventDefault();
        const validationErrs = validate();

        if (validationErrs.length) {
          alert(`Form validation errors:\n${validationErrs.join('\n')}`);
          return;
        }

        if (formControls.paymentType.value === 'globee') {
          submitGlobeePayment();
        } else {
          submitStripePayment();
        }
      });
    };

    document.addEventListener('DOMContentLoaded', e => {
      e.preventDefault();
      setUp();
    });
  </script>

  <div class="sqs-block form-block sqs-block-form" data-block-type="9">
    <div class="sqs-block-content">
      <div class="form-wrapper">
        <div class="form-inner-wrapper">
          <div class="field-list clear">
            <div class="form-item field email required">
              <label class="title" for="ticket-purchaser-name">Name<span class="required">*</span></label>
              <input class="field-element" name="email" x-autocompletetype="email" type="text" spellcheck="false"
                id="ticket-purchaser-name">
            </div>

            <div class="form-item field email required">
              <label class="title" for="ticket-purchaser-email">Email <span class="required">*</span></label>
              <input class="field-element" name="email" x-autocompletetype="email" type="text" spellcheck="false"
                id="ticket-purchaser-email">
            </div>

            <legend class="title" for="ticket-tier">Tier<span class="required">*</span></legend>

            <div class="form-item field required">
              <input type="radio" name="ticket-tier" value="general" id="ticketTier_general"><label
                for="ticketTier_general">General</label>
              <input type="radio" name="ticket-tier" value="platinum" id="ticketTier_platinum"><label
                for="ticketTier_platinum">Platinum</label>
              <input type="radio" name="ticket-tier" value="student" id="ticketTier_student"><label
                for="ticketTier_student">Student</label>
            </div>

            <div class="form-item field required">
              <label for="num-tickets"># of Tickets<span class="required">*</span></label>
              <input type="number" value="1" min="1" class="field-element" value=0 id="num-tickets" />
            </div>

            <div id="attendee-data">
              <div class="form-item field required">
                <label for="attendeeName-1">Attendee 1 Name<span class="required">*</span></label>
                <input id="attendeeName-1" name="attendeeName-1" type="text" spellcheck="false" class="field-element" />
                <label for="attendeeInstitution-1">Attendee 1 Institution</label>
                <input id="attendeeInstitution-1" Institution="attendeeInstitution-1" type="text" spellcheck="false"
                  class="field-element" />
              </div>
            </div>

            <div class="form-item field required">
              <label for="paymentType">How would you like to pay for tickets?<span class="required">*</span></label>
              <select id="payment-type" class="field-element">
                <option value="">- Select an option -</option>
                <option value="globee">Cryptocurrency (powered by Globee)</option>
                <option vlaue="stripe">Credit Card (powered by Stripe)</option>
              </select>
            </div>

            <div class="form-button-wrapper form-button-wrapper--align-left">
              <input class="button sqs-system-button sqs-editable-button" type="submit" value="Submit"
                id="submit-payment">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>


<!-- <div class="form-item field required">
  <label for="attendeeName-1">Attendee 1 Name<span class="required">*</span></label>
  <input id="attendeeName-1" name="attendeeName-1" type="text" spellcheck="false" class="field-element" />
  <label for="attendeeInstitution-1">Attendee 1 Institution<span class="required">*</span></label>
  <input id="attendeeInstitution-1" Institution="attendeeInstitution-1" type="text" spellcheck="false"
    class="field-element" />
</div> -->